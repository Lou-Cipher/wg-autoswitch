#!/bin/bash
### BEGIN INIT INFO
# Provides:          wireguard-switch
# Required-Start:    $network $remote_fs
# Required-Stop:     $network $remote_fs
# Default-Start:     2 3 4 5
# Default-Stop:      0 1 6
# Short-Description: LouCipher's Automatic WireGuard Server Switcher
# Description:       Monitors connectivity and switches the WireGuard server if the connection fails.
### END INIT INFO

SCRIPT="/usr/bin/wireguard_auto_switch.sh"
PIDFILE="/var/run/wireguard-switch.pid"

start() {
    echo "Starting WireGuard Auto-Switch..."
    nohup $SCRIPT > /var/log/wireguard-switch.log 2>&1 & echo $! > $PIDFILE
    echo "Started with PID $(cat $PIDFILE)"
}

stop() {
    echo "Stopping WireGuard Auto-Switch..."
    if [ -f $PIDFILE ]; then
        kill $(cat $PIDFILE)
        rm -f $PIDFILE
        echo "Stopped."
    else
        echo "Service is not running."
    fi
}

restart() {
    stop
    sleep 2
    start
}

status() {
    if [ -f $PIDFILE ]; then
        echo "WireGuard Auto-Switch is running with PID $(cat $PIDFILE)"
    else
        echo "WireGuard Auto-Switch is not running."
    fi
}

case "$1" in
    start) start ;;
    stop) stop ;;
    restart) restart ;;
    status) status ;;
    *) echo "Usage: $0 {start|stop|restart|status}" ;;
esac

exit 0
